# LOOM production example configuration.
# Do not commit real secrets. Load secrets from a secret manager/KMS.
# For lower config surface with secure defaults, see `.env.secure-public.example`
# and `docs/CONFIG-PROFILES.md` (`LOOM_CONFIG_PROFILE=secure_public`).
# Reviewed for v0.4.2 production baseline.

# Public service mode
LOOM_PUBLIC_SERVICE=true
LOOM_REQUIRE_TLS_PROXY=true
LOOM_TLS_PROXY_CONFIRMED=true
LOOM_REQUIRE_HTTPS_FROM_PROXY=true

# Trust proxy headers only from known ingress ranges
LOOM_TRUST_PROXY=false
LOOM_TRUST_PROXY_ALLOWLIST=203.0.113.10/32,198.51.100.0/24

# Required admin secret
LOOM_ADMIN_TOKEN=replace-with-strong-random-token

# Node identity and signing (set via secret manager)
LOOM_NODE_ID=loom-node.example.com
LOOM_REQUIRE_EXTERNAL_SIGNING_KEYS=true
LOOM_SYSTEM_SIGNING_KEY_ID=k_sign_system_1
LOOM_SYSTEM_SIGNING_PRIVATE_KEY_PEM=replace-via-secret-manager
# Optional: pre-derived public key for system signer
# LOOM_SYSTEM_SIGNING_PUBLIC_KEY_PEM=replace-via-secret-manager
LOOM_NODE_SIGNING_KEY_ID=k_node_sign_local_1
LOOM_NODE_SIGNING_PRIVATE_KEY_PEM=replace-via-secret-manager
# Recommended: keep federation signing material distinct from bridge/system signer
LOOM_REQUIRE_DISTINCT_FEDERATION_SIGNING_KEY=true
# Optional trust-anchor overrides for curated federation:
# identity-domain=node-authority-a|node-authority-b
# LOOM_FEDERATION_TRUST_ANCHORS=agents.example=fed-hub.partner.example|fed-hub-dr.partner.example
# Internet-grade trust mode (recommended for open federation)
LOOM_FEDERATION_TRUST_MODE=public_dns_webpki
LOOM_FEDERATION_TRUST_FAIL_CLOSED=true
LOOM_FEDERATION_TRUST_REQUIRE_DNSSEC=true
LOOM_FEDERATION_TRUST_DNS_RESOLVER_MODE=dnssec_doh
LOOM_FEDERATION_TRUST_DNSSEC_DOH_URL=https://cloudflare-dns.com/dns-query
LOOM_FEDERATION_TRUST_DNSSEC_DOH_TIMEOUT_MS=5000
LOOM_FEDERATION_TRUST_DNSSEC_DOH_MAX_RESPONSE_BYTES=262144
LOOM_FEDERATION_TRUST_TRANSPARENCY_MODE=local_append_only
LOOM_FEDERATION_TRUST_REQUIRE_TRANSPARENCY=true
LOOM_FEDERATION_TRUST_MAX_CLOCK_SKEW_MS=300000
LOOM_FEDERATION_TRUST_KEYSET_MAX_AGE_MS=86400000
LOOM_FEDERATION_TRUST_KEYSET_PUBLISH_TTL_MS=86400000
LOOM_FEDERATION_TRUST_DNS_TXT_LABEL=_loomfed
LOOM_FEDERATION_TRUST_LOCAL_EPOCH=1
LOOM_FEDERATION_TRUST_KEYSET_VERSION=1
# Comma-separated historical key ids (if any) to keep revoked in signed revocation doc
# LOOM_FEDERATION_REVOKED_KEY_IDS=k_node_sign_retired_2026_01

# Persistence
LOOM_PG_URL=postgresql://loom:replace-password@db.example.com:5432/loom
LOOM_PG_SSL=true
LOOM_PG_SSL_REJECT_UNAUTHORIZED=true
# Optional: encrypt local state snapshots (recommended when LOOM_DATA_DIR is used)
# LOOM_STATE_ENCRYPTION_KEY=replace-with-32-byte-key-base64url
# LOOM_REQUIRE_STATE_ENCRYPTION_AT_REST=true

# Federation and outbound host controls (required on public service)
LOOM_FEDERATION_HOST_ALLOWLIST=.partner.example.com
LOOM_FEDERATION_BOOTSTRAP_HOST_ALLOWLIST=.partner.example.com
LOOM_REMOTE_IDENTITY_HOST_ALLOWLIST=.partner.example.com
LOOM_WEBHOOK_HOST_ALLOWLIST=.internal.example.com

# Keep metrics authenticated by default
LOOM_METRICS_PUBLIC=false

# Keep demo/public-read modes disabled in production
LOOM_DEMO_PUBLIC_READS=false

# Inbound bridge hardening (public service)
LOOM_BRIDGE_EMAIL_INBOUND_ENABLED=true
LOOM_BRIDGE_EMAIL_INBOUND_PUBLIC_CONFIRMED=true
LOOM_BRIDGE_EMAIL_INBOUND_REQUIRE_ADMIN_TOKEN=true
LOOM_BRIDGE_EMAIL_INBOUND_REQUIRE_AUTH_RESULTS=true
LOOM_BRIDGE_EMAIL_INBOUND_REQUIRE_DMARC_PASS=true
LOOM_BRIDGE_EMAIL_INBOUND_REJECT_ON_AUTH_FAILURE=true
LOOM_BRIDGE_EMAIL_INBOUND_QUARANTINE_ON_AUTH_FAILURE=true
LOOM_BRIDGE_EMAIL_INBOUND_ALLOW_PAYLOAD_AUTH_RESULTS=false
# Keep bridged content non-actuating unless explicitly approved
LOOM_BRIDGE_EMAIL_INBOUND_ALLOW_AUTOMATIC_ACTUATION=false
# Required only if automatic actuation is intentionally enabled on public service
LOOM_BRIDGE_EMAIL_INBOUND_AUTOMATION_CONFIRMED=false
# Optional: retain only specific inbound headers in bridge metadata
# LOOM_BRIDGE_EMAIL_INBOUND_HEADER_ALLOWLIST=from,to,subject,date,message-id,authentication-results,received-spf
LOOM_INBOUND_CONTENT_FILTER_ENABLED=true
LOOM_INBOUND_CONTENT_FILTER_REJECT_MALWARE=true
LOOM_INBOUND_CONTENT_FILTER_PROFILE_DEFAULT=balanced
LOOM_INBOUND_CONTENT_FILTER_PROFILE_BRIDGE=strict
LOOM_INBOUND_CONTENT_FILTER_PROFILE_FEDERATION=agent
LOOM_INBOUND_CONTENT_FILTER_SPAM_THRESHOLD=3
LOOM_INBOUND_CONTENT_FILTER_PHISH_THRESHOLD=3
LOOM_INBOUND_CONTENT_FILTER_QUARANTINE_THRESHOLD=4
LOOM_INBOUND_CONTENT_FILTER_REJECT_THRESHOLD=7
# Optional: anonymized decision telemetry for threshold tuning
LOOM_INBOUND_CONTENT_FILTER_DECISION_LOG_ENABLED=false
# LOOM_INBOUND_CONTENT_FILTER_DECISION_LOG_FILE=/var/log/loom/content-filter-decisions.jsonl
# LOOM_INBOUND_CONTENT_FILTER_DECISION_LOG_SALT=replace-with-rotation-secret

# Replay protection and thread limits (v0.4.0)
LOOM_REPLAY_MODE=sliding_window
LOOM_THREAD_MAX_ENVELOPES_PER_THREAD=10000
LOOM_THREAD_MAX_PENDING_PARENTS=500

# Strongly recommended operational settings
LOOM_IDENTITY_REQUIRE_PROOF=true
LOOM_REQUIRE_PORTABLE_THREAD_OP_CAPABILITY=true
LOOM_FEDERATION_REQUIRE_SIGNED_RECEIPTS=true
LOOM_FEDERATION_CHALLENGE_ESCALATION_ENABLED=true
LOOM_FEDERATION_REQUIRE_PROTOCOL_CAPABILITIES=true
LOOM_FEDERATION_REQUIRE_E2EE_PROFILE_OVERLAP=true
LOOM_FEDERATION_REQUIRE_TRUST_MODE_PARITY=true
# Optional explicit downgrade exceptions (from>to)
# LOOM_E2EE_PROFILE_MIGRATION_ALLOWLIST=loom-e2ee-x25519-xchacha20-v2>loom-e2ee-x25519-xchacha20-v1

# Optional tuning examples (adjust from load tests)
LOOM_RATE_LIMIT_WINDOW_MS=60000
LOOM_RATE_LIMIT_DEFAULT_MAX=1000
LOOM_RATE_LIMIT_SENSITIVE_MAX=160
LOOM_IDENTITY_RATE_LIMIT_WINDOW_MS=60000
LOOM_IDENTITY_RATE_LIMIT_DEFAULT_MAX=1200
LOOM_IDENTITY_RATE_LIMIT_SENSITIVE_MAX=240
LOOM_FEDERATION_NODE_RATE_WINDOW_MS=60000
LOOM_FEDERATION_NODE_RATE_MAX=90
LOOM_FEDERATION_GLOBAL_RATE_WINDOW_MS=60000
LOOM_FEDERATION_GLOBAL_RATE_MAX=700
LOOM_OUTBOX_CLAIM_LEASE_MS=60000
LOOM_OUTBOX_WORKER_ID=loom-prod-node-1
LOOM_OUTBOX_AUTO_PROCESS_INTERVAL_MS=5000
LOOM_OUTBOX_AUTO_PROCESS_BATCH_SIZE=20
LOOM_EMAIL_OUTBOX_AUTO_PROCESS_INTERVAL_MS=5000
LOOM_EMAIL_OUTBOX_AUTO_PROCESS_BATCH_SIZE=20
LOOM_WEBHOOK_OUTBOX_AUTO_PROCESS_INTERVAL_MS=5000
LOOM_WEBHOOK_OUTBOX_AUTO_PROCESS_BATCH_SIZE=20
LOOM_MESSAGE_RETENTION_DAYS=0
LOOM_BLOB_RETENTION_DAYS=0
LOOM_MAINTENANCE_SWEEP_INTERVAL_MS=60000
# Periodic federation trust-anchor revalidation worker
LOOM_FEDERATION_TRUST_REVALIDATE_INTERVAL_MS=900000
LOOM_FEDERATION_TRUST_REVALIDATE_BATCH_LIMIT=100
# Keep `false` for internet-grade trust; non-public modes are skipped by default
LOOM_FEDERATION_TRUST_REVALIDATE_INCLUDE_NON_PUBLIC_MODES=false
LOOM_FEDERATION_TRUST_REVALIDATE_TIMEOUT_MS=5000
LOOM_FEDERATION_TRUST_REVALIDATE_MAX_RESPONSE_BYTES=262144
LOOM_REQUEST_LOG_ENABLED=true
LOOM_REQUEST_LOG_FORMAT=json

# Alternative native TLS mode (disable proxy mode when used)
# LOOM_NATIVE_TLS_ENABLED=true
# LOOM_NATIVE_TLS_CERT_FILE=/etc/loom/tls/fullchain.pem
# LOOM_NATIVE_TLS_KEY_FILE=/etc/loom/tls/privkey.pem
