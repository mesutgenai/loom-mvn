{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://loom.email/schemas/envelope-v1.1.schema.json",
  "title": "LOOM Envelope v1.1",
  "description": "JSON Schema for the LOOM Protocol envelope format v1.1",
  "type": "object",
  "required": ["loom", "id", "thread_id", "type", "from", "to", "content", "signature", "created_at"],
  "properties": {
    "loom": {
      "type": "string",
      "const": "1.1",
      "description": "Protocol version"
    },
    "id": {
      "type": "string",
      "pattern": "^env_[0-9A-HJKMNP-TV-Z]{26}$",
      "description": "Envelope ID (env_ + ULID)"
    },
    "thread_id": {
      "type": "string",
      "pattern": "^thr_[0-9A-HJKMNP-TV-Z]{26}$",
      "description": "Thread ID (thr_ + ULID)"
    },
    "parent_id": {
      "oneOf": [
        {
          "type": "string",
          "pattern": "^env_[0-9A-HJKMNP-TV-Z]{26}$"
        },
        { "type": "null" }
      ],
      "description": "Parent envelope ID for DAG threading (null for root)"
    },
    "type": {
      "type": "string",
      "enum": ["message", "task", "approval", "event", "notification", "handoff", "data", "receipt", "workflow", "thread_op"],
      "description": "Envelope type"
    },
    "from": {
      "$ref": "#/$defs/sender",
      "description": "Sender information"
    },
    "to": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/recipient" },
      "description": "Recipients (at least one primary)"
    },
    "audience": {
      "oneOf": [
        { "$ref": "#/$defs/audience" },
        { "type": "null" }
      ],
      "description": "Audience visibility control"
    },
    "content": {
      "$ref": "#/$defs/content",
      "description": "Envelope payload"
    },
    "attachments": {
      "type": "array",
      "items": { "$ref": "#/$defs/attachment" },
      "description": "Optional file attachments"
    },
    "signature": {
      "$ref": "#/$defs/signature",
      "description": "Ed25519 envelope signature"
    },
    "created_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO-8601 creation timestamp"
    },
    "expires_at": {
      "oneOf": [
        { "type": "string", "format": "date-time" },
        { "type": "null" }
      ],
      "description": "Optional expiration timestamp"
    },
    "priority": {
      "type": "string",
      "enum": ["low", "normal", "high", "urgent"],
      "description": "Message priority"
    }
  },
  "additionalProperties": true,
  "$defs": {
    "identity": {
      "type": "string",
      "pattern": "^(loom|bridge)://[^\\s]+$",
      "description": "LOOM or bridge identity URI"
    },
    "sender": {
      "type": "object",
      "required": ["identity", "key_id", "type"],
      "properties": {
        "identity": { "$ref": "#/$defs/identity" },
        "key_id": {
          "type": "string",
          "minLength": 3,
          "description": "Signing key identifier"
        },
        "type": {
          "type": "string",
          "enum": ["human", "agent", "team", "service", "bridge"],
          "description": "Sender identity type"
        },
        "delegation_chain": {
          "type": "array",
          "items": { "type": "object" },
          "description": "Required for agent senders"
        },
        "device_id": {
          "type": "string",
          "minLength": 1,
          "maxLength": 128,
          "description": "Optional sender device identifier for multi-device replay tracking"
        }
      },
      "additionalProperties": true
    },
    "recipient": {
      "type": "object",
      "required": ["identity", "role"],
      "properties": {
        "identity": { "$ref": "#/$defs/identity" },
        "role": {
          "type": "string",
          "enum": ["primary", "cc", "observer", "bcc"],
          "description": "Recipient role"
        }
      },
      "additionalProperties": true
    },
    "audience": {
      "type": "object",
      "required": ["mode"],
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["thread", "recipients", "custom"],
          "description": "Audience visibility mode"
        },
        "identities": {
          "type": "array",
          "items": { "$ref": "#/$defs/identity" },
          "description": "Required for custom audience mode"
        }
      },
      "additionalProperties": true
    },
    "content": {
      "type": "object",
      "description": "Envelope content payload. Must have human or structured (or both) when not encrypted.",
      "properties": {
        "encrypted": {
          "type": "boolean",
          "description": "Whether the content is E2EE encrypted"
        },
        "human": {
          "type": "object",
          "properties": {
            "text": {
              "type": "string",
              "description": "Human-readable message text"
            }
          }
        },
        "structured": {
          "type": "object",
          "required": ["intent"],
          "properties": {
            "intent": {
              "type": "string",
              "minLength": 1,
              "description": "Structured intent identifier"
            },
            "parameters": {
              "type": "object",
              "description": "Intent parameters"
            }
          },
          "additionalProperties": true
        },
        "profile": {
          "type": "string",
          "description": "E2EE profile identifier (when encrypted)"
        },
        "ciphertext": {
          "type": "string",
          "description": "Base64url encrypted payload (when encrypted)"
        },
        "wrapped_keys": {
          "type": "array",
          "description": "Per-recipient wrapped keys (when encrypted)"
        },
        "replay_counter": {
          "type": "integer",
          "minimum": 0,
          "description": "Replay counter for encrypted content"
        },
        "profile_commitment": {
          "type": "string",
          "description": "Profile commitment hash (when encrypted)"
        },
        "epoch": {
          "type": "integer",
          "minimum": 0,
          "description": "Encryption epoch number"
        }
      },
      "additionalProperties": true
    },
    "attachment": {
      "type": "object",
      "required": ["id", "blob_id", "hash"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^att_[0-9A-HJKMNP-TV-Z]{26}$",
          "description": "Attachment ID (att_ + ULID)"
        },
        "blob_id": {
          "type": "string",
          "pattern": "^blob_[0-9A-HJKMNP-TV-Z]{26}$",
          "description": "Blob storage ID (blob_ + ULID)"
        },
        "hash": {
          "type": "string",
          "pattern": "^sha256:[0-9a-f]+$",
          "description": "Content hash in sha256:<hex> format"
        }
      },
      "additionalProperties": true
    },
    "signature": {
      "type": "object",
      "required": ["algorithm", "key_id", "value"],
      "properties": {
        "algorithm": {
          "type": "string",
          "const": "Ed25519",
          "description": "Signature algorithm"
        },
        "key_id": {
          "type": "string",
          "minLength": 3,
          "description": "Signing key identifier"
        },
        "value": {
          "type": "string",
          "minLength": 10,
          "description": "Base64url signature value"
        },
        "context": {
          "type": "string",
          "description": "Signature context identifier (LOOM-ENVELOPE-SIG-v1)"
        }
      },
      "additionalProperties": false
    }
  }
}
