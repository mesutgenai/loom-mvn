{
  "drill_id": "federation-trust-20260220T090022Z",
  "started_at": "2026-02-20T09:00:22.479Z",
  "success": false,
  "steps": [
    {
      "name": "register_local_admin_identity",
      "status": 201,
      "ok": true,
      "url": "http://127.0.0.1:63748/v1/identity",
      "response_body": {
        "id": "loom://admin-8eg3fiai@local.test",
        "type": "human",
        "display_name": "Drill Admin",
        "signing_keys": [
          {
            "key_id": "k_sign_local_admin_8eg3fiai",
            "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEA9osQhBq5eKscaw/u5yzvxO0zS7PY3cZZPD/9hlQtZrs=\n-----END PUBLIC KEY-----"
          }
        ],
        "encryption_keys": [],
        "created_at": "2026-02-20T09:00:22.510Z",
        "updated_at": "2026-02-20T09:00:22.510Z",
        "identity_source": "local",
        "imported_remote": false,
        "remote_fetched_at": null,
        "remote_expires_at": null
      }
    },
    {
      "name": "issue_local_auth_challenge",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:63748/v1/auth/challenge",
      "response_body": {
        "challenge_id": "chl_01KHX4EPKM7ZRKC3GVV0QQYM1B",
        "identity": "loom://admin-8eg3fiai@local.test",
        "key_id": "k_sign_local_admin_8eg3fiai",
        "nonce": "nonce_01KHX4EPKM7ZRKC3GVV0QQYM1C",
        "expires_at": "2026-02-20T09:02:22.516Z",
        "algorithm": "Ed25519"
      }
    },
    {
      "name": "exchange_local_auth_token",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:63748/v1/auth/token",
      "response_body": {
        "token_type": "Bearer",
        "access_token": "at_1ba5da2b8fd74189b03905888d3a1fc3",
        "refresh_token": "rt_0f1506f4587743688f606a66d28d5f1e",
        "expires_in": 3600,
        "identity": "loom://admin-8eg3fiai@local.test",
        "key_id": "k_sign_local_admin_8eg3fiai"
      }
    },
    {
      "name": "register_remote_sender_identity",
      "status": 201,
      "ok": true,
      "url": "http://127.0.0.1:63748/v1/identity",
      "response_body": {
        "id": "loom://sender-8eg3fiai@remote.test",
        "type": "human",
        "display_name": "Remote Sender",
        "signing_keys": [
          {
            "key_id": "k_sign_remote_sender_8eg3fiai",
            "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAsGRuax8yG+ELjQB1MqQ8uFFrpDAvs8aW5WRepvb5Qh4=\n-----END PUBLIC KEY-----"
          }
        ],
        "encryption_keys": [],
        "created_at": "2026-02-20T09:00:22.519Z",
        "updated_at": "2026-02-20T09:00:22.519Z",
        "identity_source": "remote",
        "imported_remote": true,
        "remote_fetched_at": "2026-02-20T09:00:22.519Z",
        "remote_expires_at": "2026-02-21T09:00:22.519Z"
      }
    },
    {
      "name": "bootstrap_remote_federation_trust",
      "status": 201,
      "ok": true,
      "url": "http://127.0.0.1:63748/v1/federation/nodes/bootstrap",
      "response_body": {
        "node": {
          "node_id": "remote.test",
          "key_id": "k_node_sign_remote_8eg3fiai",
          "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAqOCa8PQ1agj/NjGy7uXECskOslUp7l5kkErOyIZFqlU=\n-----END PUBLIC KEY-----",
          "signing_keys": [
            {
              "key_id": "k_node_sign_remote_8eg3fiai",
              "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAqOCa8PQ1agj/NjGy7uXECskOslUp7l5kkErOyIZFqlU=\n-----END PUBLIC KEY-----",
              "status": "active",
              "not_before": null,
              "not_after": null,
              "revoked_at": null
            }
          ],
          "deliver_url": "http://127.0.0.1:63747/v1/federation/deliver",
          "identity_resolve_url": "http://127.0.0.1:63747/v1/identity/{identity}",
          "node_document_url": "http://127.0.0.1:63747/.well-known/loom.json",
          "allow_insecure_http": true,
          "allow_private_network": true,
          "configured_policy": "trusted",
          "policy": "trusted",
          "trust_anchor_mode": "public_dns_webpki",
          "trust_anchor_dns_name": "_loomfed.remote.test",
          "trust_anchor_dns_record": "v=loomfed1;keyset=http://127.0.0.1:63747/.well-known/loom-keyset.json;digest=sha256:afead02ec24ea75981740a42e1076c6e1eb1a6a333ab3be9b23451af5efd8525;revocations=http://127.0.0.1:63747/.well-known/loom-revocations.json;trust_epoch=1;version=1",
          "trust_anchor_keyset_url": "http://127.0.0.1:63747/.well-known/loom-keyset.json",
          "trust_anchor_keyset_hash": "afead02ec24ea75981740a42e1076c6e1eb1a6a333ab3be9b23451af5efd8525",
          "trust_anchor_keyset_version": 1,
          "trust_anchor_epoch": 1,
          "trust_anchor_verified_at": "2026-02-20T09:00:22.528Z",
          "trust_anchor_revocations_url": "http://127.0.0.1:63747/.well-known/loom-revocations.json",
          "revoked_key_ids": [],
          "auto_policy": null,
          "auto_policy_until": null,
          "auto_policy_reason": null,
          "challenge_required_until": null,
          "challenge_reason": null,
          "reputation_score": 0,
          "created_at": "2026-02-20T09:00:22.528Z",
          "updated_at": "2026-02-20T09:00:22.528Z"
        },
        "discovery": {
          "node_document_url": "http://127.0.0.1:63747/.well-known/loom.json",
          "fetched_at": "2026-02-20T09:00:22.528Z"
        }
      }
    },
    {
      "name": "rotate_remote_trust_epoch_and_version",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:63747/v1/federation/trust",
      "response_body": {
        "trust_anchor_mode": "public_dns_webpki",
        "trust_anchor_fail_closed": true,
        "trust_anchor_dns_txt_label": "_loomfed",
        "trust_anchor_max_clock_skew_ms": 300000,
        "trust_anchor_keyset_max_age_ms": 86400000,
        "trust_anchor_keyset_publish_ttl_ms": 86400000,
        "trust_anchor_bindings_count": 0,
        "trust_epoch": 2,
        "keyset_version": 2,
        "revoked_key_ids": [],
        "dns": {
          "version": "loomfed1",
          "dns_name": "_loomfed.remote.test",
          "txt_record": "v=loomfed1;keyset=https://localhost/.well-known/loom-keyset.json;digest=sha256:69c929dc6d02741847523ebebe4fba082cf064fd01f56b045812dc86ea31a8b5;revocations=https://localhost/.well-known/loom-revocations.json;trust_epoch=2;version=2",
          "trust_epoch": 2,
          "keyset_version": 2,
          "keyset_url": "https://localhost/.well-known/loom-keyset.json",
          "revocations_url": "https://localhost/.well-known/loom-revocations.json",
          "generated_at": "2026-02-20T09:00:22.529Z"
        }
      }
    },
    {
      "name": "trigger_one_revalidation_cycle",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:63748/v1/federation/nodes/revalidate",
      "response_body": {
        "requested_count": 1,
        "attempted_count": 1,
        "revalidated_count": 1,
        "skipped_count": 0,
        "failed_count": 0,
        "processed": [
          {
            "node_id": "remote.test",
            "status": "revalidated",
            "node": {
              "node_id": "remote.test",
              "key_id": "k_node_sign_remote_8eg3fiai",
              "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAqOCa8PQ1agj/NjGy7uXECskOslUp7l5kkErOyIZFqlU=\n-----END PUBLIC KEY-----",
              "signing_keys": [
                {
                  "key_id": "k_node_sign_remote_8eg3fiai",
                  "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAqOCa8PQ1agj/NjGy7uXECskOslUp7l5kkErOyIZFqlU=\n-----END PUBLIC KEY-----",
                  "status": "active",
                  "not_before": null,
                  "not_after": null,
                  "revoked_at": null
                }
              ],
              "deliver_url": "http://127.0.0.1:63747/v1/federation/deliver",
              "identity_resolve_url": "http://127.0.0.1:63747/v1/identity/{identity}",
              "node_document_url": "http://127.0.0.1:63747/.well-known/loom.json",
              "allow_insecure_http": true,
              "allow_private_network": true,
              "configured_policy": "trusted",
              "policy": "trusted",
              "trust_anchor_mode": "public_dns_webpki",
              "trust_anchor_dns_name": "_loomfed.remote.test",
              "trust_anchor_dns_record": "v=loomfed1;keyset=http://127.0.0.1:63747/.well-known/loom-keyset.json;digest=sha256:f7c1d22a9b73814fc9e455200bd72c8af1b3c81027aa8211309da707859f9f27;revocations=http://127.0.0.1:63747/.well-known/loom-revocations.json;trust_epoch=2;version=2",
              "trust_anchor_keyset_url": "http://127.0.0.1:63747/.well-known/loom-keyset.json",
              "trust_anchor_keyset_hash": "f7c1d22a9b73814fc9e455200bd72c8af1b3c81027aa8211309da707859f9f27",
              "trust_anchor_keyset_version": 2,
              "trust_anchor_epoch": 2,
              "trust_anchor_verified_at": "2026-02-20T09:00:22.536Z",
              "trust_anchor_revocations_url": "http://127.0.0.1:63747/.well-known/loom-revocations.json",
              "revoked_key_ids": [],
              "auto_policy": null,
              "auto_policy_until": null,
              "auto_policy_reason": null,
              "challenge_required_until": null,
              "challenge_reason": null,
              "reputation_score": 0,
              "created_at": "2026-02-20T09:00:22.528Z",
              "updated_at": "2026-02-20T09:00:22.536Z"
            },
            "previous": {
              "trust_epoch": 1,
              "keyset_version": 1,
              "keyset_hash": "afead02ec24ea75981740a42e1076c6e1eb1a6a333ab3be9b23451af5efd8525"
            },
            "next": {
              "trust_epoch": 2,
              "keyset_version": 2,
              "keyset_hash": "f7c1d22a9b73814fc9e455200bd72c8af1b3c81027aa8211309da707859f9f27"
            },
            "discovery": {
              "node_document_url": "http://127.0.0.1:63747/.well-known/loom.json",
              "fetched_at": "2026-02-20T09:00:22.536Z"
            }
          }
        ],
        "skipped": [],
        "failed": []
      }
    },
    {
      "name": "list_local_federation_nodes_after_revalidation",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:63748/v1/federation/nodes",
      "response_body": {
        "nodes": [
          {
            "node_id": "remote.test",
            "key_id": "k_node_sign_remote_8eg3fiai",
            "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAqOCa8PQ1agj/NjGy7uXECskOslUp7l5kkErOyIZFqlU=\n-----END PUBLIC KEY-----",
            "signing_keys": [
              {
                "key_id": "k_node_sign_remote_8eg3fiai",
                "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAqOCa8PQ1agj/NjGy7uXECskOslUp7l5kkErOyIZFqlU=\n-----END PUBLIC KEY-----",
                "status": "active",
                "not_before": null,
                "not_after": null,
                "revoked_at": null
              }
            ],
            "deliver_url": "http://127.0.0.1:63747/v1/federation/deliver",
            "identity_resolve_url": "http://127.0.0.1:63747/v1/identity/{identity}",
            "node_document_url": "http://127.0.0.1:63747/.well-known/loom.json",
            "allow_insecure_http": true,
            "allow_private_network": true,
            "configured_policy": "trusted",
            "policy": "trusted",
            "trust_anchor_mode": "public_dns_webpki",
            "trust_anchor_dns_name": "_loomfed.remote.test",
            "trust_anchor_dns_record": "v=loomfed1;keyset=http://127.0.0.1:63747/.well-known/loom-keyset.json;digest=sha256:f7c1d22a9b73814fc9e455200bd72c8af1b3c81027aa8211309da707859f9f27;revocations=http://127.0.0.1:63747/.well-known/loom-revocations.json;trust_epoch=2;version=2",
            "trust_anchor_keyset_url": "http://127.0.0.1:63747/.well-known/loom-keyset.json",
            "trust_anchor_keyset_hash": "f7c1d22a9b73814fc9e455200bd72c8af1b3c81027aa8211309da707859f9f27",
            "trust_anchor_keyset_version": 2,
            "trust_anchor_epoch": 2,
            "trust_anchor_verified_at": "2026-02-20T09:00:22.536Z",
            "trust_anchor_revocations_url": "http://127.0.0.1:63747/.well-known/loom-revocations.json",
            "revoked_key_ids": [],
            "auto_policy": null,
            "auto_policy_until": null,
            "auto_policy_reason": null,
            "challenge_required_until": null,
            "challenge_reason": null,
            "reputation_score": 0,
            "created_at": "2026-02-20T09:00:22.528Z",
            "updated_at": "2026-02-20T09:00:22.536Z"
          }
        ]
      }
    },
    {
      "name": "deliver_with_stale_trust_epoch_header",
      "status": 401,
      "ok": false,
      "url": "http://127.0.0.1:63748/v1/federation/deliver",
      "response_body": {
        "error": {
          "code": "SIGNATURE_INVALID",
          "message": "Federation request trust epoch is stale",
          "details": {
            "node_id": "remote.test",
            "expected_epoch": 2,
            "request_epoch": 1
          },
          "request_id": "req_fcbecad1-45e5-4f02-8af3-a5b67a0e4e30",
          "timestamp": "2026-02-20T09:00:22.538Z"
        }
      }
    },
    {
      "name": "deliver_with_fresh_trust_epoch_header",
      "status": 400,
      "ok": false,
      "url": "http://127.0.0.1:63748/v1/federation/deliver",
      "response_body": {
        "error": {
          "code": "ENVELOPE_INVALID",
          "message": "Envelope fails validation",
          "details": {
            "errors": [
              {
                "field": "id",
                "reason": "must be env_ + ULID"
              },
              {
                "field": "thread_id",
                "reason": "must be thr_ + ULID"
              }
            ]
          },
          "request_id": "req_38191b5f-a207-425a-8967-8e8d5b3fc710",
          "timestamp": "2026-02-20T09:00:22.540Z"
        }
      }
    }
  ],
  "remote_base_url": "http://127.0.0.1:63747",
  "local_base_url": "http://127.0.0.1:63748",
  "finished_at": "2026-02-20T09:00:22.540Z",
  "failure": "Fresh trust epoch delivery failed (expected HTTP 202, got 400)"
}
