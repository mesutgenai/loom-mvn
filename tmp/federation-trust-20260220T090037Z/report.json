{
  "drill_id": "federation-trust-20260220T090037Z",
  "started_at": "2026-02-20T09:00:37.780Z",
  "success": true,
  "steps": [
    {
      "name": "register_local_admin_identity",
      "status": 201,
      "ok": true,
      "url": "http://127.0.0.1:63907/v1/identity",
      "response_body": {
        "id": "loom://admin-irodmpuz@local.test",
        "type": "human",
        "display_name": "Drill Admin",
        "signing_keys": [
          {
            "key_id": "k_sign_local_admin_irodmpuz",
            "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAvwdpJ4kX3viPS4XxokfglYATB7ZL096kodhjOLkpKyc=\n-----END PUBLIC KEY-----"
          }
        ],
        "encryption_keys": [],
        "created_at": "2026-02-20T09:00:37.800Z",
        "updated_at": "2026-02-20T09:00:37.800Z",
        "identity_source": "local",
        "imported_remote": false,
        "remote_fetched_at": null,
        "remote_expires_at": null
      }
    },
    {
      "name": "issue_local_auth_challenge",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:63907/v1/auth/challenge",
      "response_body": {
        "challenge_id": "chl_01KHX4F5HCN67K0MY4R3Z2ADXY",
        "identity": "loom://admin-irodmpuz@local.test",
        "key_id": "k_sign_local_admin_irodmpuz",
        "nonce": "nonce_01KHX4F5HCN67K0MY4R3Z2ADXZ",
        "expires_at": "2026-02-20T09:02:37.804Z",
        "algorithm": "Ed25519"
      }
    },
    {
      "name": "exchange_local_auth_token",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:63907/v1/auth/token",
      "response_body": {
        "token_type": "Bearer",
        "access_token": "at_eddf91c846a84402b9980b83eba1e250",
        "refresh_token": "rt_6d9f7efd15a344e29840446099178935",
        "expires_in": 3600,
        "identity": "loom://admin-irodmpuz@local.test",
        "key_id": "k_sign_local_admin_irodmpuz"
      }
    },
    {
      "name": "register_remote_sender_identity",
      "status": 201,
      "ok": true,
      "url": "http://127.0.0.1:63907/v1/identity",
      "response_body": {
        "id": "loom://sender-irodmpuz@remote.test",
        "type": "human",
        "display_name": "Remote Sender",
        "signing_keys": [
          {
            "key_id": "k_sign_remote_sender_irodmpuz",
            "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEA31APtQzU7hQsYKHGkxCyg0bNRlMvpwQUEOwXFdtlgIA=\n-----END PUBLIC KEY-----"
          }
        ],
        "encryption_keys": [],
        "created_at": "2026-02-20T09:00:37.807Z",
        "updated_at": "2026-02-20T09:00:37.807Z",
        "identity_source": "remote",
        "imported_remote": true,
        "remote_fetched_at": "2026-02-20T09:00:37.807Z",
        "remote_expires_at": "2026-02-21T09:00:37.807Z"
      }
    },
    {
      "name": "bootstrap_remote_federation_trust",
      "status": 201,
      "ok": true,
      "url": "http://127.0.0.1:63907/v1/federation/nodes/bootstrap",
      "response_body": {
        "node": {
          "node_id": "remote.test",
          "key_id": "k_node_sign_remote_irodmpuz",
          "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEABepBXJQOMAU2UTmStGWubRDSjj8Y2KQEdVZRGen3niE=\n-----END PUBLIC KEY-----",
          "signing_keys": [
            {
              "key_id": "k_node_sign_remote_irodmpuz",
              "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEABepBXJQOMAU2UTmStGWubRDSjj8Y2KQEdVZRGen3niE=\n-----END PUBLIC KEY-----",
              "status": "active",
              "not_before": null,
              "not_after": null,
              "revoked_at": null
            }
          ],
          "deliver_url": "http://127.0.0.1:63906/v1/federation/deliver",
          "identity_resolve_url": "http://127.0.0.1:63906/v1/identity/{identity}",
          "node_document_url": "http://127.0.0.1:63906/.well-known/loom.json",
          "allow_insecure_http": true,
          "allow_private_network": true,
          "configured_policy": "trusted",
          "policy": "trusted",
          "trust_anchor_mode": "public_dns_webpki",
          "trust_anchor_dns_name": "_loomfed.remote.test",
          "trust_anchor_dns_record": "v=loomfed1;keyset=http://127.0.0.1:63906/.well-known/loom-keyset.json;digest=sha256:b6c9445d1ce7d02758a5cd885334fa0b9aec44826420ffe70abac263c9e7ff63;revocations=http://127.0.0.1:63906/.well-known/loom-revocations.json;trust_epoch=1;version=1",
          "trust_anchor_keyset_url": "http://127.0.0.1:63906/.well-known/loom-keyset.json",
          "trust_anchor_keyset_hash": "b6c9445d1ce7d02758a5cd885334fa0b9aec44826420ffe70abac263c9e7ff63",
          "trust_anchor_keyset_version": 1,
          "trust_anchor_epoch": 1,
          "trust_anchor_verified_at": "2026-02-20T09:00:37.815Z",
          "trust_anchor_revocations_url": "http://127.0.0.1:63906/.well-known/loom-revocations.json",
          "revoked_key_ids": [],
          "auto_policy": null,
          "auto_policy_until": null,
          "auto_policy_reason": null,
          "challenge_required_until": null,
          "challenge_reason": null,
          "reputation_score": 0,
          "created_at": "2026-02-20T09:00:37.815Z",
          "updated_at": "2026-02-20T09:00:37.815Z"
        },
        "discovery": {
          "node_document_url": "http://127.0.0.1:63906/.well-known/loom.json",
          "fetched_at": "2026-02-20T09:00:37.815Z"
        }
      }
    },
    {
      "name": "rotate_remote_trust_epoch_and_version",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:63906/v1/federation/trust",
      "response_body": {
        "trust_anchor_mode": "public_dns_webpki",
        "trust_anchor_fail_closed": true,
        "trust_anchor_dns_txt_label": "_loomfed",
        "trust_anchor_max_clock_skew_ms": 300000,
        "trust_anchor_keyset_max_age_ms": 86400000,
        "trust_anchor_keyset_publish_ttl_ms": 86400000,
        "trust_anchor_bindings_count": 0,
        "trust_epoch": 2,
        "keyset_version": 2,
        "revoked_key_ids": [],
        "dns": {
          "version": "loomfed1",
          "dns_name": "_loomfed.remote.test",
          "txt_record": "v=loomfed1;keyset=https://localhost/.well-known/loom-keyset.json;digest=sha256:a65adc20f852e99ef76ccaee58f458e4dab025a29f08c95d2a7db0d841bba199;revocations=https://localhost/.well-known/loom-revocations.json;trust_epoch=2;version=2",
          "trust_epoch": 2,
          "keyset_version": 2,
          "keyset_url": "https://localhost/.well-known/loom-keyset.json",
          "revocations_url": "https://localhost/.well-known/loom-revocations.json",
          "generated_at": "2026-02-20T09:00:37.818Z"
        }
      }
    },
    {
      "name": "trigger_one_revalidation_cycle",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:63907/v1/federation/nodes/revalidate",
      "response_body": {
        "requested_count": 1,
        "attempted_count": 1,
        "revalidated_count": 1,
        "skipped_count": 0,
        "failed_count": 0,
        "processed": [
          {
            "node_id": "remote.test",
            "status": "revalidated",
            "node": {
              "node_id": "remote.test",
              "key_id": "k_node_sign_remote_irodmpuz",
              "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEABepBXJQOMAU2UTmStGWubRDSjj8Y2KQEdVZRGen3niE=\n-----END PUBLIC KEY-----",
              "signing_keys": [
                {
                  "key_id": "k_node_sign_remote_irodmpuz",
                  "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEABepBXJQOMAU2UTmStGWubRDSjj8Y2KQEdVZRGen3niE=\n-----END PUBLIC KEY-----",
                  "status": "active",
                  "not_before": null,
                  "not_after": null,
                  "revoked_at": null
                }
              ],
              "deliver_url": "http://127.0.0.1:63906/v1/federation/deliver",
              "identity_resolve_url": "http://127.0.0.1:63906/v1/identity/{identity}",
              "node_document_url": "http://127.0.0.1:63906/.well-known/loom.json",
              "allow_insecure_http": true,
              "allow_private_network": true,
              "configured_policy": "trusted",
              "policy": "trusted",
              "trust_anchor_mode": "public_dns_webpki",
              "trust_anchor_dns_name": "_loomfed.remote.test",
              "trust_anchor_dns_record": "v=loomfed1;keyset=http://127.0.0.1:63906/.well-known/loom-keyset.json;digest=sha256:d93373b969b32e5435dbb767012431017d239fd31e88b24311f31b85bfad4eeb;revocations=http://127.0.0.1:63906/.well-known/loom-revocations.json;trust_epoch=2;version=2",
              "trust_anchor_keyset_url": "http://127.0.0.1:63906/.well-known/loom-keyset.json",
              "trust_anchor_keyset_hash": "d93373b969b32e5435dbb767012431017d239fd31e88b24311f31b85bfad4eeb",
              "trust_anchor_keyset_version": 2,
              "trust_anchor_epoch": 2,
              "trust_anchor_verified_at": "2026-02-20T09:00:37.821Z",
              "trust_anchor_revocations_url": "http://127.0.0.1:63906/.well-known/loom-revocations.json",
              "revoked_key_ids": [],
              "auto_policy": null,
              "auto_policy_until": null,
              "auto_policy_reason": null,
              "challenge_required_until": null,
              "challenge_reason": null,
              "reputation_score": 0,
              "created_at": "2026-02-20T09:00:37.815Z",
              "updated_at": "2026-02-20T09:00:37.821Z"
            },
            "previous": {
              "trust_epoch": 1,
              "keyset_version": 1,
              "keyset_hash": "b6c9445d1ce7d02758a5cd885334fa0b9aec44826420ffe70abac263c9e7ff63"
            },
            "next": {
              "trust_epoch": 2,
              "keyset_version": 2,
              "keyset_hash": "d93373b969b32e5435dbb767012431017d239fd31e88b24311f31b85bfad4eeb"
            },
            "discovery": {
              "node_document_url": "http://127.0.0.1:63906/.well-known/loom.json",
              "fetched_at": "2026-02-20T09:00:37.821Z"
            }
          }
        ],
        "skipped": [],
        "failed": []
      }
    },
    {
      "name": "list_local_federation_nodes_after_revalidation",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:63907/v1/federation/nodes",
      "response_body": {
        "nodes": [
          {
            "node_id": "remote.test",
            "key_id": "k_node_sign_remote_irodmpuz",
            "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEABepBXJQOMAU2UTmStGWubRDSjj8Y2KQEdVZRGen3niE=\n-----END PUBLIC KEY-----",
            "signing_keys": [
              {
                "key_id": "k_node_sign_remote_irodmpuz",
                "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEABepBXJQOMAU2UTmStGWubRDSjj8Y2KQEdVZRGen3niE=\n-----END PUBLIC KEY-----",
                "status": "active",
                "not_before": null,
                "not_after": null,
                "revoked_at": null
              }
            ],
            "deliver_url": "http://127.0.0.1:63906/v1/federation/deliver",
            "identity_resolve_url": "http://127.0.0.1:63906/v1/identity/{identity}",
            "node_document_url": "http://127.0.0.1:63906/.well-known/loom.json",
            "allow_insecure_http": true,
            "allow_private_network": true,
            "configured_policy": "trusted",
            "policy": "trusted",
            "trust_anchor_mode": "public_dns_webpki",
            "trust_anchor_dns_name": "_loomfed.remote.test",
            "trust_anchor_dns_record": "v=loomfed1;keyset=http://127.0.0.1:63906/.well-known/loom-keyset.json;digest=sha256:d93373b969b32e5435dbb767012431017d239fd31e88b24311f31b85bfad4eeb;revocations=http://127.0.0.1:63906/.well-known/loom-revocations.json;trust_epoch=2;version=2",
            "trust_anchor_keyset_url": "http://127.0.0.1:63906/.well-known/loom-keyset.json",
            "trust_anchor_keyset_hash": "d93373b969b32e5435dbb767012431017d239fd31e88b24311f31b85bfad4eeb",
            "trust_anchor_keyset_version": 2,
            "trust_anchor_epoch": 2,
            "trust_anchor_verified_at": "2026-02-20T09:00:37.821Z",
            "trust_anchor_revocations_url": "http://127.0.0.1:63906/.well-known/loom-revocations.json",
            "revoked_key_ids": [],
            "auto_policy": null,
            "auto_policy_until": null,
            "auto_policy_reason": null,
            "challenge_required_until": null,
            "challenge_reason": null,
            "reputation_score": 0,
            "created_at": "2026-02-20T09:00:37.815Z",
            "updated_at": "2026-02-20T09:00:37.821Z"
          }
        ]
      }
    },
    {
      "name": "deliver_with_stale_trust_epoch_header",
      "status": 401,
      "ok": false,
      "url": "http://127.0.0.1:63907/v1/federation/deliver",
      "response_body": {
        "error": {
          "code": "SIGNATURE_INVALID",
          "message": "Federation request trust epoch is stale",
          "details": {
            "node_id": "remote.test",
            "expected_epoch": 2,
            "request_epoch": 1
          },
          "request_id": "req_612895bf-511f-4110-933e-fbdc53b1397e",
          "timestamp": "2026-02-20T09:00:37.823Z"
        }
      }
    },
    {
      "name": "deliver_with_fresh_trust_epoch_header",
      "status": 202,
      "ok": true,
      "url": "http://127.0.0.1:63907/v1/federation/deliver",
      "response_body": {
        "sender_node": "remote.test",
        "accepted_count": 1,
        "rejected_count": 0,
        "accepted_envelope_ids": [
          "env_01KHX4F5HYATQY5ERNZ0HVJ356"
        ],
        "receipt": {
          "loom": "1.1",
          "type": "federation.delivery.receipt@v1",
          "delivery_id": "fdel_01KHX4F5J1G7TXGNX5STPVHARF",
          "sender_node": "local.test",
          "recipient_node": "remote.test",
          "status": "accepted",
          "accepted_count": 1,
          "accepted_envelope_ids": [
            "env_01KHX4F5HYATQY5ERNZ0HVJ356"
          ],
          "timestamp": "2026-02-20T09:00:37.825Z",
          "signature": {
            "algorithm": "Ed25519",
            "key_id": "k_node_sign_local_1",
            "value": "ld5WA-IFFtGKBKb3UDWSAWWpEWqiwxtFQgpDQXwTIuLp2k2cS1PKVNDjZE8ev666oYF4X7sB-QWORH7sCPN0BA"
          }
        }
      }
    }
  ],
  "remote_base_url": "http://127.0.0.1:63906",
  "local_base_url": "http://127.0.0.1:63907",
  "assertions": {
    "bootstrap_epoch": 1,
    "bootstrap_keyset_version": 1,
    "rotated_epoch": 2,
    "rotated_keyset_version": 2,
    "revalidation_previous_epoch": 1,
    "revalidation_next_epoch": 2,
    "revalidation_previous_keyset_version": 1,
    "revalidation_next_keyset_version": 2,
    "stale_epoch_delivery_rejected": true,
    "fresh_epoch_delivery_accepted": true
  },
  "finished_at": "2026-02-20T09:00:37.826Z"
}
