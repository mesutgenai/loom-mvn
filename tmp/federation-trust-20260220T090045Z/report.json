{
  "drill_id": "federation-trust-20260220T090045Z",
  "started_at": "2026-02-20T09:00:45.950Z",
  "success": true,
  "steps": [
    {
      "name": "register_local_admin_identity",
      "status": 201,
      "ok": true,
      "url": "http://127.0.0.1:64299/v1/identity",
      "response_body": {
        "id": "loom://admin-dej4mnqs@local.test",
        "type": "human",
        "display_name": "Drill Admin",
        "signing_keys": [
          {
            "key_id": "k_sign_local_admin_dej4mnqs",
            "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAC63DUNJbRiONYy0bXbftV9bYYHL2hUYVigA7g2Gb7B4=\n-----END PUBLIC KEY-----"
          }
        ],
        "encryption_keys": [],
        "created_at": "2026-02-20T09:00:45.971Z",
        "updated_at": "2026-02-20T09:00:45.971Z",
        "identity_source": "local",
        "imported_remote": false,
        "remote_fetched_at": null,
        "remote_expires_at": null
      }
    },
    {
      "name": "issue_local_auth_challenge",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:64299/v1/auth/challenge",
      "response_body": {
        "challenge_id": "chl_01KHX4FDGRK6BE82JMBXRF1EPQ",
        "identity": "loom://admin-dej4mnqs@local.test",
        "key_id": "k_sign_local_admin_dej4mnqs",
        "nonce": "nonce_01KHX4FDGRK6BE82JMBXRF1EPR",
        "expires_at": "2026-02-20T09:02:45.976Z",
        "algorithm": "Ed25519"
      }
    },
    {
      "name": "exchange_local_auth_token",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:64299/v1/auth/token",
      "response_body": {
        "token_type": "Bearer",
        "access_token": "at_a05d02d491a5408fb72ef3d3886d3908",
        "refresh_token": "rt_57c5a2c2bd454c3abffb5081e874ab96",
        "expires_in": 3600,
        "identity": "loom://admin-dej4mnqs@local.test",
        "key_id": "k_sign_local_admin_dej4mnqs"
      }
    },
    {
      "name": "register_remote_sender_identity",
      "status": 201,
      "ok": true,
      "url": "http://127.0.0.1:64299/v1/identity",
      "response_body": {
        "id": "loom://sender-dej4mnqs@remote.test",
        "type": "human",
        "display_name": "Remote Sender",
        "signing_keys": [
          {
            "key_id": "k_sign_remote_sender_dej4mnqs",
            "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEA7FNyUuRwS7arkp2n50xg40kwEnSx1Ra4TXgtJvxqfg8=\n-----END PUBLIC KEY-----"
          }
        ],
        "encryption_keys": [],
        "created_at": "2026-02-20T09:00:45.979Z",
        "updated_at": "2026-02-20T09:00:45.979Z",
        "identity_source": "remote",
        "imported_remote": true,
        "remote_fetched_at": "2026-02-20T09:00:45.979Z",
        "remote_expires_at": "2026-02-21T09:00:45.979Z"
      }
    },
    {
      "name": "bootstrap_remote_federation_trust",
      "status": 201,
      "ok": true,
      "url": "http://127.0.0.1:64299/v1/federation/nodes/bootstrap",
      "response_body": {
        "node": {
          "node_id": "remote.test",
          "key_id": "k_node_sign_remote_dej4mnqs",
          "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAcOPGaDLvb4a/AqINyQvptUgc0T0WineMI/168kSpfC8=\n-----END PUBLIC KEY-----",
          "signing_keys": [
            {
              "key_id": "k_node_sign_remote_dej4mnqs",
              "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAcOPGaDLvb4a/AqINyQvptUgc0T0WineMI/168kSpfC8=\n-----END PUBLIC KEY-----",
              "status": "active",
              "not_before": null,
              "not_after": null,
              "revoked_at": null
            }
          ],
          "deliver_url": "http://127.0.0.1:64298/v1/federation/deliver",
          "identity_resolve_url": "http://127.0.0.1:64298/v1/identity/{identity}",
          "node_document_url": "http://127.0.0.1:64298/.well-known/loom.json",
          "allow_insecure_http": true,
          "allow_private_network": true,
          "configured_policy": "trusted",
          "policy": "trusted",
          "trust_anchor_mode": "public_dns_webpki",
          "trust_anchor_dns_name": "_loomfed.remote.test",
          "trust_anchor_dns_record": "v=loomfed1;keyset=http://127.0.0.1:64298/.well-known/loom-keyset.json;digest=sha256:0a8b0d227e267bc275941316826d89738be71fbf3cedbee5e94c5d4fa02cac34;revocations=http://127.0.0.1:64298/.well-known/loom-revocations.json;trust_epoch=1;version=1",
          "trust_anchor_keyset_url": "http://127.0.0.1:64298/.well-known/loom-keyset.json",
          "trust_anchor_keyset_hash": "0a8b0d227e267bc275941316826d89738be71fbf3cedbee5e94c5d4fa02cac34",
          "trust_anchor_keyset_version": 1,
          "trust_anchor_epoch": 1,
          "trust_anchor_verified_at": "2026-02-20T09:00:45.989Z",
          "trust_anchor_revocations_url": "http://127.0.0.1:64298/.well-known/loom-revocations.json",
          "revoked_key_ids": [],
          "auto_policy": null,
          "auto_policy_until": null,
          "auto_policy_reason": null,
          "challenge_required_until": null,
          "challenge_reason": null,
          "reputation_score": 0,
          "created_at": "2026-02-20T09:00:45.989Z",
          "updated_at": "2026-02-20T09:00:45.989Z"
        },
        "discovery": {
          "node_document_url": "http://127.0.0.1:64298/.well-known/loom.json",
          "fetched_at": "2026-02-20T09:00:45.989Z"
        }
      }
    },
    {
      "name": "rotate_remote_trust_epoch_and_version",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:64298/v1/federation/trust",
      "response_body": {
        "trust_anchor_mode": "public_dns_webpki",
        "trust_anchor_fail_closed": true,
        "trust_anchor_dns_txt_label": "_loomfed",
        "trust_anchor_max_clock_skew_ms": 300000,
        "trust_anchor_keyset_max_age_ms": 86400000,
        "trust_anchor_keyset_publish_ttl_ms": 86400000,
        "trust_anchor_bindings_count": 0,
        "trust_epoch": 2,
        "keyset_version": 2,
        "revoked_key_ids": [],
        "dns": {
          "version": "loomfed1",
          "dns_name": "_loomfed.remote.test",
          "txt_record": "v=loomfed1;keyset=https://localhost/.well-known/loom-keyset.json;digest=sha256:57ce06fc78b8482528365dc580712e07fa9d8418ff2dcca0755bc39aac9d85ae;revocations=https://localhost/.well-known/loom-revocations.json;trust_epoch=2;version=2",
          "trust_epoch": 2,
          "keyset_version": 2,
          "keyset_url": "https://localhost/.well-known/loom-keyset.json",
          "revocations_url": "https://localhost/.well-known/loom-revocations.json",
          "generated_at": "2026-02-20T09:00:45.991Z"
        }
      }
    },
    {
      "name": "trigger_one_revalidation_cycle",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:64299/v1/federation/nodes/revalidate",
      "response_body": {
        "requested_count": 1,
        "attempted_count": 1,
        "revalidated_count": 1,
        "skipped_count": 0,
        "failed_count": 0,
        "processed": [
          {
            "node_id": "remote.test",
            "status": "revalidated",
            "node": {
              "node_id": "remote.test",
              "key_id": "k_node_sign_remote_dej4mnqs",
              "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAcOPGaDLvb4a/AqINyQvptUgc0T0WineMI/168kSpfC8=\n-----END PUBLIC KEY-----",
              "signing_keys": [
                {
                  "key_id": "k_node_sign_remote_dej4mnqs",
                  "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAcOPGaDLvb4a/AqINyQvptUgc0T0WineMI/168kSpfC8=\n-----END PUBLIC KEY-----",
                  "status": "active",
                  "not_before": null,
                  "not_after": null,
                  "revoked_at": null
                }
              ],
              "deliver_url": "http://127.0.0.1:64298/v1/federation/deliver",
              "identity_resolve_url": "http://127.0.0.1:64298/v1/identity/{identity}",
              "node_document_url": "http://127.0.0.1:64298/.well-known/loom.json",
              "allow_insecure_http": true,
              "allow_private_network": true,
              "configured_policy": "trusted",
              "policy": "trusted",
              "trust_anchor_mode": "public_dns_webpki",
              "trust_anchor_dns_name": "_loomfed.remote.test",
              "trust_anchor_dns_record": "v=loomfed1;keyset=http://127.0.0.1:64298/.well-known/loom-keyset.json;digest=sha256:100fa9722e9e8bbf3fdc3319d13f8dedfae0fd9b39bdd0ecb13521e81feeeb85;revocations=http://127.0.0.1:64298/.well-known/loom-revocations.json;trust_epoch=2;version=2",
              "trust_anchor_keyset_url": "http://127.0.0.1:64298/.well-known/loom-keyset.json",
              "trust_anchor_keyset_hash": "100fa9722e9e8bbf3fdc3319d13f8dedfae0fd9b39bdd0ecb13521e81feeeb85",
              "trust_anchor_keyset_version": 2,
              "trust_anchor_epoch": 2,
              "trust_anchor_verified_at": "2026-02-20T09:00:45.997Z",
              "trust_anchor_revocations_url": "http://127.0.0.1:64298/.well-known/loom-revocations.json",
              "revoked_key_ids": [],
              "auto_policy": null,
              "auto_policy_until": null,
              "auto_policy_reason": null,
              "challenge_required_until": null,
              "challenge_reason": null,
              "reputation_score": 0,
              "created_at": "2026-02-20T09:00:45.989Z",
              "updated_at": "2026-02-20T09:00:45.997Z"
            },
            "previous": {
              "trust_epoch": 1,
              "keyset_version": 1,
              "keyset_hash": "0a8b0d227e267bc275941316826d89738be71fbf3cedbee5e94c5d4fa02cac34"
            },
            "next": {
              "trust_epoch": 2,
              "keyset_version": 2,
              "keyset_hash": "100fa9722e9e8bbf3fdc3319d13f8dedfae0fd9b39bdd0ecb13521e81feeeb85"
            },
            "discovery": {
              "node_document_url": "http://127.0.0.1:64298/.well-known/loom.json",
              "fetched_at": "2026-02-20T09:00:45.998Z"
            }
          }
        ],
        "skipped": [],
        "failed": []
      }
    },
    {
      "name": "list_local_federation_nodes_after_revalidation",
      "status": 200,
      "ok": true,
      "url": "http://127.0.0.1:64299/v1/federation/nodes",
      "response_body": {
        "nodes": [
          {
            "node_id": "remote.test",
            "key_id": "k_node_sign_remote_dej4mnqs",
            "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAcOPGaDLvb4a/AqINyQvptUgc0T0WineMI/168kSpfC8=\n-----END PUBLIC KEY-----",
            "signing_keys": [
              {
                "key_id": "k_node_sign_remote_dej4mnqs",
                "public_key_pem": "-----BEGIN PUBLIC KEY-----\nMCowBQYDK2VwAyEAcOPGaDLvb4a/AqINyQvptUgc0T0WineMI/168kSpfC8=\n-----END PUBLIC KEY-----",
                "status": "active",
                "not_before": null,
                "not_after": null,
                "revoked_at": null
              }
            ],
            "deliver_url": "http://127.0.0.1:64298/v1/federation/deliver",
            "identity_resolve_url": "http://127.0.0.1:64298/v1/identity/{identity}",
            "node_document_url": "http://127.0.0.1:64298/.well-known/loom.json",
            "allow_insecure_http": true,
            "allow_private_network": true,
            "configured_policy": "trusted",
            "policy": "trusted",
            "trust_anchor_mode": "public_dns_webpki",
            "trust_anchor_dns_name": "_loomfed.remote.test",
            "trust_anchor_dns_record": "v=loomfed1;keyset=http://127.0.0.1:64298/.well-known/loom-keyset.json;digest=sha256:100fa9722e9e8bbf3fdc3319d13f8dedfae0fd9b39bdd0ecb13521e81feeeb85;revocations=http://127.0.0.1:64298/.well-known/loom-revocations.json;trust_epoch=2;version=2",
            "trust_anchor_keyset_url": "http://127.0.0.1:64298/.well-known/loom-keyset.json",
            "trust_anchor_keyset_hash": "100fa9722e9e8bbf3fdc3319d13f8dedfae0fd9b39bdd0ecb13521e81feeeb85",
            "trust_anchor_keyset_version": 2,
            "trust_anchor_epoch": 2,
            "trust_anchor_verified_at": "2026-02-20T09:00:45.997Z",
            "trust_anchor_revocations_url": "http://127.0.0.1:64298/.well-known/loom-revocations.json",
            "revoked_key_ids": [],
            "auto_policy": null,
            "auto_policy_until": null,
            "auto_policy_reason": null,
            "challenge_required_until": null,
            "challenge_reason": null,
            "reputation_score": 0,
            "created_at": "2026-02-20T09:00:45.989Z",
            "updated_at": "2026-02-20T09:00:45.997Z"
          }
        ]
      }
    },
    {
      "name": "deliver_with_stale_trust_epoch_header",
      "status": 401,
      "ok": false,
      "url": "http://127.0.0.1:64299/v1/federation/deliver",
      "response_body": {
        "error": {
          "code": "SIGNATURE_INVALID",
          "message": "Federation request trust epoch is stale",
          "details": {
            "node_id": "remote.test",
            "expected_epoch": 2,
            "request_epoch": 1
          },
          "request_id": "req_1c6f0859-4a02-47e0-bddc-b24246d46d4f",
          "timestamp": "2026-02-20T09:00:46.001Z"
        }
      }
    },
    {
      "name": "deliver_with_fresh_trust_epoch_header",
      "status": 202,
      "ok": true,
      "url": "http://127.0.0.1:64299/v1/federation/deliver",
      "response_body": {
        "sender_node": "remote.test",
        "accepted_count": 1,
        "rejected_count": 0,
        "accepted_envelope_ids": [
          "env_01KHX4FDHF1AVMV5F58FWE6VN8"
        ],
        "receipt": {
          "loom": "1.1",
          "type": "federation.delivery.receipt@v1",
          "delivery_id": "fdel_01KHX4FDHKN45W200FWST237BA",
          "sender_node": "local.test",
          "recipient_node": "remote.test",
          "status": "accepted",
          "accepted_count": 1,
          "accepted_envelope_ids": [
            "env_01KHX4FDHF1AVMV5F58FWE6VN8"
          ],
          "timestamp": "2026-02-20T09:00:46.003Z",
          "signature": {
            "algorithm": "Ed25519",
            "key_id": "k_node_sign_local_1",
            "value": "yNFqaGCyVggyyONiohwr8EzwE9tHv_k4HMk_YpU3uIxhQrLWR0veIXMChiMNL0pa3ZsxoM3OKk6_x3xT1Yd6AQ"
          }
        }
      }
    }
  ],
  "remote_base_url": "http://127.0.0.1:64298",
  "local_base_url": "http://127.0.0.1:64299",
  "assertions": {
    "bootstrap_epoch": 1,
    "bootstrap_keyset_version": 1,
    "rotated_epoch": 2,
    "rotated_keyset_version": 2,
    "revalidation_previous_epoch": 1,
    "revalidation_next_epoch": 2,
    "revalidation_previous_keyset_version": 1,
    "revalidation_next_keyset_version": 2,
    "stale_epoch_delivery_rejected": true,
    "fresh_epoch_delivery_accepted": true
  },
  "finished_at": "2026-02-20T09:00:46.004Z"
}
